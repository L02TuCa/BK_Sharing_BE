# See https://fly.io/docs/app-guides/continuous-deployment-with-github-actions/

name: Fly Deploy
on:
  push:
    branches:
      - main
jobs:
  deploy:
    name: Deploy app
    runs-on: ubuntu-latest
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
    concurrency:
      # This creates a unique group per workflow and branch
      group: ${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch all history for proper versioning
          fetch-depth: 0
      - name: Setup Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master
#      - name: Build application
#        run: ./mvnw package -DskipTests
      - name: Set Fly.io secrets (if needed)
        # Only run this when secrets need updating
        if: true  # Set to true only when rotating secrets
        run: |
          flyctl secrets set \
            SUPABASE_KEY="${{ secrets.SUPABASE_KEY }}" \
            SUPABASE_URL="https://mdygwitoqcbfhxohuazt.supabase.co" \
            SUPABASE_BUCKET="bk-docs" \
            SPRING_DATASOURCE_URL="${{ secrets.SPRING_DATASOURCE_URL }}" \
            DB_USERNAME="${{ secrets.DB_USERNAME }}" \
            DB_PASSWORD="${{ secrets.DB_PASSWORD }}" \
            --app bk-sharing-app
      - name: Deploy to Fly.io
        run: flyctl deploy --remote-only --app bk-sharing-app